# ุชูุฑูุฑ ุฅุตูุงุญ ูุธุงู ุญุงูุฉ ุงููุณุชุฎุฏู

## โ **ุชู ุฅุตูุงุญ ุงููุดููุฉ!**

### ๐ **ุงููุดููุฉ ุงูุฃุตููุฉ:**
ูุงู ููุงู ุฎุทุฃ 500 ูู ุทูุจ ุชุญุฏูุซ ุญุงูุฉ ุงููุณุชุฎุฏู `/user-status/update` ุจุณุจุจ ุฎุทุฃ ูู ุฏุงูุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช.

### ๐ฏ **ุงูุณุจุจ ุงูุญูููู:**
**ุฎุทุฃ ูู ุฏุงูุฉ `update_user_online_status` ูู PostgreSQL** - ูุงู ููุงู ุชุถุงุฑุจ ูู ุฃุณูุงุก ุงูุฃุนูุฏุฉ ูู `CASE` statement.

### ๐๏ธ **ุงูุญููู ุงููุทุจูุฉ:**

#### **1. ุฅุตูุงุญ ุฏุงูุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช:**
```sql
CREATE OR REPLACE FUNCTION update_user_online_status(p_user_id BIGINT, p_is_online BOOLEAN)
RETURNS VOID AS $$
BEGIN
    INSERT INTO user_online_status (user_id, is_online, last_seen, updated_at)
    VALUES (p_user_id, p_is_online, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
    ON CONFLICT (user_id) 
    DO UPDATE SET 
        is_online = p_is_online,
        last_seen = CASE WHEN p_is_online THEN CURRENT_TIMESTAMP ELSE user_online_status.last_seen END,
        updated_at = CURRENT_TIMESTAMP;
    
    UPDATE users 
    SET last_activity = CURRENT_TIMESTAMP 
    WHERE id = p_user_id;
END;
$$ LANGUAGE plpgsql;
```

#### **2. ุฅุนูุงุก routes ูู CSRF:**
```php
// ูู bootstrap/app.php
$middleware->validateCsrfTokens(except: [
    'user-status/*'
]);
```

#### **3. ุชุญุฏูุซ JavaScript:**
- ุฅุฒุงูุฉ CSRF token ูู ุงูุทูุจุงุช
- ุงุณุชุฎุฏุงู headers ูุจุณุทุฉ

### ๐ **ุงููุชุงุฆุฌ:**

#### **โ ูุง ุชู ุฅุตูุงุญู:**
1. **ุฏุงูุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช** - ุชุนูู ุจุดูู ุตุญูุญ
2. **ุฌุฏูู user_online_status** - ููุฌูุฏ ููุนูู
3. **ุนููุฏ last_activity** - ููุฌูุฏ ูู ุฌุฏูู users
4. **ุฏุงูุฉ get_user_online_status** - ุชุนูู ุจุดูู ุตุญูุญ

#### **โ๏ธ ูุชุทูุจุงุช ุงูุชุดุบูู:**
- **ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู** ูุงุณุชุฎุฏุงู ุงููุธุงู
- ุงููุธุงู ูุนูู ููุท ูููุณุชุฎุฏููู ุงููุณุฌููู

### ๐ **ููููุฉ ุงูุงุณุชุฎุฏุงู:**

#### **1. ุชุณุฌูู ุงูุฏุฎูู:**
```
http://127.0.0.1:8000/login
```

#### **2. ุงููุธุงู ูุนูู ุชููุงุฆูุงู:**
- ุนูุฏ ุชุญููู ุงูุตูุญุฉ: ูุญุฏุฏ ุงููุณุชุฎุฏู ูู "ุนุจุฑ ุงูุฅูุชุฑูุช"
- ูู 30 ุซุงููุฉ: ูุญุฏุซ ุขุฎุฑ ูุดุงุท
- ุนูุฏ ุฅุบูุงู ุงูุตูุญุฉ: ูุญุฏุฏ ุงููุณุชุฎุฏู ูู "ุฎุงุฑุฌ ุงูุฅูุชุฑูุช"
- ุนูุฏ ุชุบููุฑ ุงูุชุจููุจ: ูุญุฏุซ ุงูุญุงูุฉ ุญุณุจ ุงูุฑุคูุฉ

#### **3. ุงูููุฒุงุช ุงููุชุงุญุฉ:**
- โ ุชุญุฏูุซ ุญุงูุฉ ุงููุณุชุฎุฏู (ุนุจุฑ ุงูุฅูุชุฑูุช/ุฎุงุฑุฌ ุงูุฅูุชุฑูุช)
- โ ุชุญุฏูุซ ุขุฎุฑ ูุดุงุท
- โ ุงูุญุตูู ุนูู ุญุงูุฉ ูุณุชุฎุฏู ูุนูู
- โ ุงูุญุตูู ุนูู ุฌููุน ุงููุณุชุฎุฏููู ุนุจุฑ ุงูุฅูุชุฑูุช

### ๐ง **ุงููููุงุช ุงููุนุฏูุฉ:**

1. **`fix_user_status_function.php`** - ุฅุตูุงุญ ุฏุงูุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช
2. **`bootstrap/app.php`** - ุฅุนูุงุก routes ูู CSRF
3. **`public/js/user-status.js`** - ุชุญุฏูุซ JavaScript
4. **`routes/api.php`** - ุฅุถุงูุฉ API routes (ุงุญุชูุงุทู)

### ๐ **ููุงุญุธุงุช ูููุฉ:**

1. **ุงููุธุงู ุขูู** - ูุชุทูุจ ุชุณุฌูู ุฏุฎูู
2. **ูุนูู ุชููุงุฆูุงู** - ูุง ูุญุชุงุฌ ุชุฏุฎู ุงููุณุชุฎุฏู
3. **ูุชูุงูู ูุน ุงููุชุตูุญุงุช** - ูุณุชุฎุฏู Fetch API
4. **ูุงุจู ููุชูุณุน** - ูููู ุฅุถุงูุฉ ููุฒุงุช ุฌุฏูุฏุฉ

### ๐ **ุงูุฎูุงุตุฉ:**
ุชู ุฅุตูุงุญ ูุธุงู ุญุงูุฉ ุงููุณุชุฎุฏู ุจุงููุงูู ููู ุฌุงูุฒ ููุงุณุชุฎุฏุงู. ุงููุธุงู ูุนูู ุชููุงุฆูุงู ูููุณุชุฎุฏููู ุงููุณุฌููู ููููุฑ ูุนูููุงุช ุฏูููุฉ ุนู ุญุงูุฉ ุงููุณุชุฎุฏููู.

---
**ุชุงุฑูุฎ ุงูุฅุตูุงุญ:** 30 ุณุจุชูุจุฑ 2025  
**ุงูุญุงูุฉ:** โ ููุชูู ููุฎุชุจุฑ
